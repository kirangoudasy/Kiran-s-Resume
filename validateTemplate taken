onUploadPress: async function () {
  const module = this.byId("moduleComboBox").getSelectedKey();
  const subModule = this.byId("subModuleComboBox").getSelectedKey();
  const template = this.byId("loadTemplateComboBox").getSelectedKey();
  const oFileUploader = this.byId("fileUploader");
  const file = oFileUploader.getDomRef("fu").files?.[0];

  if (!module || !subModule || !template || !file) {
    sap.m.MessageBox.error("Please select all dropdowns and choose a file.");
    return;
  }

  const maxSize = 20 * 1024 * 1024;
  if (file.size > maxSize) {
    sap.m.MessageBox.error("File size exceeds 20 MB.");
    return;
  }

  sap.ui.core.BusyIndicator.show(0);

  try {
    // ---------- READ FILE ----------
    const base64Content = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(",")[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    const payload = {
      MODULE_NAME: module,
      SUB_MODULE_NAME: subModule,
      LOAD_TEMPLATE: template,
      FILE_NAME: file.name,
      STATUS: "uploaded",
      FILE_MIME_TYPE: file.type,
      FILE_SIZE: file.size,
      FILE_CONTENT: base64Content
    };

    // ---------- STEP 1: CREATE (runs Generic Data Validator) ----------
    const listBinding = this.oModel.bindList("/ReportFileStorage");
    const context = await listBinding.create(payload);
    await context.created(); // ‚ùå throws if proc fails

    // ---------- STEP 2: CALL ValidateTemplate (different validation) ----------
    const oFunction = this.oModel.bindContext("/ValidateTemplate(...)");
    oFunction.setParameter("MODULE_NAME", module);
    oFunction.setParameter("SUB_MODULE_NAME", subModule);
    oFunction.setParameter("LOAD_TEMPLATE", template);
    oFunction.setParameter("FILE_CONTENT", base64Content);

    await oFunction.execute();
    const result = oFunction.getBoundContext().getObject();

    if (result?.flag === false) {
      sap.m.MessageBox.error(result.message || "Template validation failed");
      return;
    }

    // ---------- SUCCESS ----------
    sap.m.MessageBox.success("File uploaded and validated successfully");

    const oTable = this.byId("fileTable");
    const oBinding = oTable.getBinding("rows");
    if (oBinding) oBinding.refresh();

  } catch (error) {
    // ---------- GENERIC DATA VALIDATOR FAILED ----------
    let message = "Upload failed";

    if (error?.responseText) {
      try {
        const odataError = JSON.parse(error.responseText);
        message =
          odataError?.error?.message?.value ||
          odataError?.error?.message ||
          message;
      } catch (e) {}
    }

    sap.m.MessageBox.error(message);
  } finally {
    sap.ui.core.BusyIndicator.hide();
  }
}
