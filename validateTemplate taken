// step -2 run the proc to find if all good

const db = await cds.connect.to('db');

let errorMsg = "[]";   // default → no duplicates

try {
  const callProcSQL = `
    CALL "GENERIC_DATA_VALIDATOR"(
      P_ID             => '${key}',
      P_MODULE         => '${MODULE_NAME}',
      P_SUB_MODULE     => '${SUB_MODULE_NAME}',
      P_LOAD_TEMPLATE => '${LOAD_TEMPLATE}'
    )
  `;

  await db.run(callProcSQL);

  // step -3 proc should set up error message or valid
  const procResult = await db.run(
    SELECT
      .from('com.scb.fileupload.master.DataValidator')
      .columns('ERROR_MESSAGE')
      .where({ ID: key })
  );

  errorMsg = procResult?.[0]?.ERROR_MESSAGE || "[]";

} catch (err) {
  // handle "no data found" thrown by procedure when no duplicates exist
  if (
    err.message &&
    err.message.toLowerCase().includes("no data found")
  ) {
    errorMsg = "[]";   // treat as valid
  } else {
    throw err;         // real error → fail
  }
}

// step -4 return message

if (errorMsg && errorMsg !== "[]" && errorMsg.trim() !== "") {
  return {
    message: errorMsg,
    flag: false
  };
}

return {
  message: "Validation successful. No duplicates found.",
  flag: true
};
