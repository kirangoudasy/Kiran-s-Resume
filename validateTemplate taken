PROCEDURE "GENERIC_DATA_VALIDATOR"
(
    IN  P_ID            NVARCHAR(36),
    IN  P_MODULE        NVARCHAR(100),
    IN  P_SUB_MODULE    NVARCHAR(100),
    IN  P_LOAD_TEMPLATE NVARCHAR(100)
)
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER
AS

   LV_TEMPLATE_SQL NVARCHAR(10000);
   LV_COLUMNS NVARCHAR(10000);
   LV_JSON_COLS NVARCHAR(10000);
   LV_SELECT_COLS NVARCHAR(10000);
   LV_SQL NVARCHAR(10000);
   LV_TEMPLATE_ID NVARCHAR(100);
   LV_VALID_FLAG BOOLEAN;
   LV_COL_DEF NVARCHAR(1000);
   LV_CREATE_SQL NVARCHAR(10000);
   LV_DROP_SQL NVARCHAR(100);
   LV_ROW_CNT INTEGER;
   LV_COUNT_QUERY NVARCHAR(100);
   LV_JSON_SQL NVARCHAR(10000);
   LV_RESULT_NCLOB NCLOB;


BEGIN

       CREATE LOCAL TEMPORARY TABLE #TMP_UNIQUE_COLS (
        COLUMN_NAME NVARCHAR(200),
        DATA_TYPE   NVARCHAR(200)
    );

    SELECT ID INTO LV_TEMPLATE_ID FROM COM_SCB_FILEUPLOAD_MASTER_TEMPLATESTORAGE 
        WHERE MODULE_NAME     = :P_MODULE
             AND SUB_MODULE_NAME = :P_SUB_MODULE
             AND LOAD_TEMPLATE   = :P_LOAD_TEMPLATE;

    LV_TEMPLATE_SQL :=
        'INSERT INTO #TMP_UNIQUE_COLS SELECT
            JT.COLUMN_NAME,
            JT.DATA_TYPE
         FROM
         COM_SCB_FILEUPLOAD_MASTER_TEMPLATESTORAGE
            CROSS JOIN JSON_TABLE(
                (SELECT JSON_TEMPLATE FROM COM_SCB_FILEUPLOAD_MASTER_TEMPLATESTORAGE WHERE ID = ''' || :LV_TEMPLATE_ID || ''' ),
                ''$[*]''
                COLUMNS (
                    COLUMN_NAME NVARCHAR(200) PATH ''$.COLUMN_NAME'' ,
                    DATA_TYPE NVARCHAR(200) PATH ''$.DATA_TYPE'' ,
                    IS_UNIQUE   NVARCHAR(200)       PATH ''$.IS_UNIQUE''
                )
            ) JT
         WHERE
            JT.IS_UNIQUE = ''true'' AND
            COM_SCB_FILEUPLOAD_MASTER_TEMPLATESTORAGE.ID = ''' || :LV_TEMPLATE_ID || '''
        ';

    EXECUTE IMMEDIATE :LV_TEMPLATE_SQL;

    SELECT STRING_AGG(
          COLUMN_NAME || ' ' || DATA_TYPE ||
          ' PATH ''$.' || COLUMN_NAME || '''',
          ', '
    )
    INTO LV_JSON_COLS
    FROM #TMP_UNIQUE_COLS;

    SELECT STRING_AGG('JT.' || COLUMN_NAME, ', ')
    INTO LV_SELECT_COLS
    FROM #TMP_UNIQUE_COLS;

    SELECT STRING_AGG(
    COLUMN_NAME || ' ' || DATA_TYPE,
    ', '
    )
    INTO LV_COL_DEF
    FROM #TMP_UNIQUE_COLS;

    LV_CREATE_SQL :=
    'CREATE LOCAL TEMPORARY TABLE #TMP_RESULT (
        ' || :LV_COL_DEF || ',
        DUP_CNT INTEGER
    )';

    EXECUTE IMMEDIATE :LV_CREATE_SQL;

        LV_SQL :=
        'INSERT INTO #TMP_RESULT
        SELECT
            ' || :LV_SELECT_COLS || ' ,
            COUNT(*) AS DUP_CNT
         FROM
         COM_SCB_FILEUPLOAD_MASTER_DATAVALIDATOR
            CROSS JOIN JSON_TABLE(
                (SELECT JSON_DATA FROM COM_SCB_FILEUPLOAD_MASTER_DATAVALIDATOR WHERE ID = ''' || :P_ID || ''' ),
                ''$[*]''
                COLUMNS (
                   '|| :LV_JSON_COLS ||'
                )
            ) JT
         WHERE
            COM_SCB_FILEUPLOAD_MASTER_DATAVALIDATOR.ID = ''' || :P_ID || '''
         GROUP BY
            ' || :LV_SELECT_COLS || '
         HAVING COUNT(*) > 1';

    EXECUTE IMMEDIATE :LV_SQL;


    LV_JSON_SQL :=
        'SELECT * FROM #TMP_RESULT FOR JSON;';

    EXECUTE IMMEDIATE :LV_JSON_SQL INTO LV_RESULT_NCLOB;

    UPDATE COM_SCB_FILEUPLOAD_MASTER_DATAVALIDATOR 
    SET ERROR_MESSAGE = :LV_RESULT_NCLOB
    WHERE ID = :P_ID;

    LV_DROP_SQL := 'DROP TABLE #TMP_RESULT';
    EXECUTE IMMEDIATE :LV_DROP_SQL;
    DROP TABLE #TMP_UNIQUE_COLS;

END;
